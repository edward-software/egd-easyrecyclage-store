{% extends "@PaprecPublic/Common/Base/base_need.html.twig" %}

{#{% block title %}#}

{#{% endblock %}#}

{#{% block stylesheets %}#}

{#{% endblock %}#}

{% block sidebar %}
    <div class="need-form d3e-need-form"></div>
    {# Définition des menus affichés dans la sidebar #}
    {% set besoin = 'active' %}
    {% set coordonnees = '' %}
    {% if cart.type == 'order' %}
        {% set livraison = '' %}
        {% set paiement = '' %}
    {% elseif cart.type == 'quote' %}
        {% set offre = '' %}
    {% endif %}
    {{ parent() }}
{% endblock %}

{% block cta_panel %}
    <div>
        <a class="step__tab active"
           href="#">{{ 'Public.Cart.NeedEstimation'|trans }}</a>
        <a class="step__tab"
           href="{{ path('paprec_public_corp_home_requestWriting_step1', {cartUuid: cart.id}) }}">{{ 'Public.Cart.FillForm'|trans }}</a>
        <div class="clearfix"></div>
    </div>
{% endblock %}

{% block product_step_title %}
    {{ 'Public.Cart.MyServices'|trans }}
{% endblock %}

{% block products %}
    {% set cpt = 5 %}
    {% set displayedProduct = "" %}
    {# On parcourt la liste des produits D3E #}
    {% for product in products %}
        {% if (cpt == 5) %}
            <div class="first-row">
        {% endif %}
        {% if (cpt%5 == 0 and cpt > 5) %}
            <div class="following-row">
        {% endif %}
        {% if product.id in cart.displayedProducts %}
            {% set displayedProduct = product %}
        {% endif %}
        <div class="checkboxPicto productCheckboxPicto {% if product.id in cart.displayedProducts %}  active {% endif %}"
             id="productCheckboxPicto_{{ product.id }}"
             data-url="{{ path('paprec_public_corp_d3e_subscription_addOrRemoveDisplayedProduct', {cartUuid: cart.id, productId: product.id}) }}"
             style="{% if product.pictos|length > 0 %}background-image: url({{ asset('/uploads/pictos/' ~ product.pictos[0].path) }}) {% endif %}">
            {{ product.name }}
            {% for items in cart.content %}
                {% if items['pId'] == product.id %}
                    <span class="number">{{ items['qtty'] }}</span>
                {% endif %}
            {% endfor %}
        </div>
        {% set cpt = cpt + 1 %}

        {% if ((cpt%5 == 0) and (cpt > 5)) or loop.last %}
            </div>
            {% if cart.displayedProducts and displayedProduct != '' %}
                <div class="infoproduct">
                    <div class="left">
                        <div class="infoproduct__title">
                            {{ ('Public.Cart.QuantifyNeed'|trans)|upper }}
                        </div>

                        <div class="clearfix"></div>

                        {# Si le produit sélectionné est déjà dans le Cart on récupère la quantité et les options qui étaient choisis #}
                        {% set qtty = '' %}
                        {% set optHandling = '' %}
                        {% set optSerialNumberStmt = '' %}
                        {% set optDestruction = '' %}
                        {% for items in cart.content %}
                            {% if items['pId'] == displayedProduct.id %}
                                {% set qtty = items['qtty'] %}
                                {% if items['optHandling'] == '1' %}
                                    {% set optHandling = '1' %}
                                {% endif %}
                                {% if items['optSerialNumberStmt'] == '1' %}
                                    {% set optSerialNumberStmt = '1' %}
                                {% endif %}
                                {% if items['optDestruction'] == '1' %}
                                    {% set optDestruction = '1' %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        <br>

                        <div class="infoproduct__qtytitle">{{ 'Public.Cart.Qtty'|trans }}</div>
                        <select name=""
                                id="quantityProducSelect_{{ displayedProduct.id }}"
                                class="infoproduct__qty">
                            {% for i in 1..10 %}
                                {% if i == qtty %}
                                    <option value="{{ i }}"
                                            selected="selected">{{ i }}</option>
                                {% else %}
                                    <option value="{{ i }}">{{ i }}</option>

                                {% endif %}
                            {% endfor %}
                        </select>
                        <br><br>

                        <div class="-align-right">
                            <input type="checkbox"
                                   id="optHandlingProductSelect_{{ displayedProduct.id }}"
                                    {% if optHandling is defined and optHandling == '1' %} checked{% endif %}>
                            {{ 'Commercial.ProductD3EOrderLine.OptHandling'|trans }}<br>

                            <input type="checkbox"
                                   id="optSerialNumberStmtProductSelect_{{ displayedProduct.id }}"
                                    {% if optSerialNumberStmt is defined and optSerialNumberStmt == '1' %} checked{% endif %}>
                            {{ 'Commercial.ProductD3EOrderLine.OptSerialNumberStmt'|trans }}<br>

                            <input type="checkbox"
                                   id="optDestructionProductSelect_{{ displayedProduct.id }}"
                                    {% if optDestruction is defined and optDestruction == '1' %} checked{% endif %}>
                            {{ 'Commercial.ProductD3EOrderLine.OptDestruction'|trans }}<br>
                        </div>
                        <br>

                        <button class="button button--lightgreen addToCartSubmitButton"
                             data-url="{{ path('paprec_public_corp_d3e_subscription_addContent', {cartUuid: cart.id, productId: displayedProduct.id, quantity: 'quantityTmp', optHandling: 'optHandlingTmp', optSerialNumberStmt: 'optSerialNumberStmtTmp', optDestruction: 'optDestructionTmp'}) }}"
                             id="addToCartSubmitButton_{{ displayedProduct.id }}">{{ ('Public.Cart.AddToCart' ~ cart.type|capitalize)|trans }}
                        </button>
                    </div>
                    <div class="right">
                        <div class="infoproduct__close"
                             data-url="{{ path('paprec_public_corp_d3e_subscription_addOrRemoveDisplayedProduct', {cartUuid: cart.id, productId: displayedProduct.id}) }}"
                             id="infoProductClose_{{ displayedProduct.id }}"></div>

                        <div class="infoproduct__wrapperdesc">
                            <div class="infoproduct__title">{{ 'Public.Cart.ServiceDesc'|trans }}</div>
                            {{ displayedProduct.description|nl2br }}
                        </div>

                    </div>
                    <div class="clearfix"></div>
                </div>
                {% set displayedProduct = '' %}
            {% endif %}
            <div class="clearfix"></div>
        {% endif %}
    {% endfor %}
{% endblock %}

{% block cta_bottom_panel %}
    <div class="step">
        {{ render(controller('PaprecPublicBundle:Common:getCTAsBottom', {
            'label': 'ValidateNeed',
            'cartUuid': cart.id,
            'division': cart.division,
            'stepBack': '',
            'nextStep': 'step2',
            'idSubmit': '',
            'cartEmpty': cart.content is empty
        })) }}
    </div>
{% endblock %}

{% block javascripts %}
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?libraries=places&key={{ paprec_google_api_key }}">
    </script>
{% endblock %}
